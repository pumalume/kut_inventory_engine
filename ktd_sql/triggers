DELIMITER //

CREATE TRIGGER trg_ktd_production_deduction
AFTER INSERT ON ktd_production_log
FOR EACH ROW
BEGIN
    -- Only deduct stock if the production is marked as COMPLETED
    IF NEW.status = 'COMPLETED' THEN
        INSERT INTO ktd_stock_ledger (
            branch_id, 
            ingredient_id, 
            quantity_change, 
            reason, 
            ai_context
        )
        SELECT 
            NEW.branch_id, 
            r.ingredient_id, 
            (r.qty_required * NEW.batch_quantity * -1), -- Negative value for consumption
            'PRODUCTION',
            CONCAT('Auto-deduction for production ID: ', NEW.production_id)
        FROM ktd_recipes r
        WHERE r.product_id = NEW.product_id;
    END IF;
END; //

DELIMITER ;


-- Logic: On Production Completion -> Deduct Recipe Ingredients
CREATE TRIGGER trg_ktd_production_deduction
AFTER UPDATE ON ktd_production_log
FOR EACH ROW
BEGIN
    IF NEW.status = 'COMPLETED' AND OLD.status != 'COMPLETED' THEN
        INSERT INTO ktd_stock_ledger ... (qty_required * batch_quantity * -1)
    END IF;
END;
